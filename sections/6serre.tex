\section{Serre duality}
The rest of this paper is devoted to proving the Serre duality:
\begin{thm}[Serre Duality]
  If $X$ is an algebraic curve as in the previous section
  and $D$ is a divisor on $X$, there is an isomorphism
  \[
    \dual{D}\cong H^{0}(X, K_{X}
    \otimes \mathcal{L}(D)^{\vee}).
  \]
  of $k$-vector spaces, where $K_{X}$ is the canonical divisor of $X$.
\end{thm}
We will prove the theorem by first finding a more concrete representation of
$H^{1}(X,\mathcal{L}(D))$ and then constructing a perfect pairing between
$H^{1}(X,\mathcal{L}(D))$ and $H^{0}(X,K_{X}\otimes\mathcal{L}(D)^{\vee})$,
which will give us the isomorphism.

\subsection{Concrete representation of $H^{1}(X,\mathcal{L}(D))$}
To prove the Serre duality, we do not want to directly work with the \v Cech
cohomology definition of $H^{1}(X,\mathcal{L}(D))$.
Instead we want to find some SES involving $\mathcal{L}(D)$,
take the cohomology sequence of the SES, and then use it to simplify
the definition of $H^{1}(X,\mathcal{L}(D))$. Since $\mathcal{L}(D)$ is
a subsheaf of the constant sheaf $\underline{k(X)}$, we can simply consider
the following SES.
\[
  \begin{tikzcd}
    0\rar & \mathcal{L}(D)\rar & \underline{k(X)}\rar
    & \underline{k(X)}/\mathcal{L}(D)\rar & 0,
  \end{tikzcd}
\]
which yields the following exact sequence
\[
  \begin{tikzcd}
    H^{0}(X,\underline{k(X)})\rar & H^{0}(X,\underline{k(X)}
    /\mathcal{L}(D))\rar & H^{1}(X,\mathcal{L}(D))\rar
    & H^{1}(X,\underline{k(X)}).
  \end{tikzcd}
\]
But Prop.~\ref{prop:const_sheaf} implies that
$H^{0}(X,\underline{k(X)})=k(X)$ and $H^{1}(X,\underline{k(X)})=0$
so that the exact sequence simplifies to
\[
  \begin{tikzcd}
    k(X)\rar & H^{0}(X,\underline{k(X)}/\mathcal{L}(D))\rar
    & H^{1}(X,\mathcal{L}(D))\rar & 0.
  \end{tikzcd}
\]
Let us first try to understand the space
$H^{0}(X,\underline{k(X)}/\mathcal{L}(D))$. An element of the space
is of the form $([f_{P}])_{P\in X}$, where $[f_{P}]$ is the equivalence
class of some $f_{P}\in k(X)$ modulo $\mathcal{L}(D)_{P}$.
Note that the $f_{P}$ must be related together so that the sections
satisfy sheaf axioms, and it would be easier if we didn't need to worry about
this condition. We can in fact construct an isomorphic vector space, which is
similar, but where we don't need to worry about the sheaf axioms. To see
this, first make the following observation.
\begin{prop}
  If $(f_{P})_{P\in X}\in \Gamma(\underline{k(X)})$,
  $f_{P}\in\mathscr{O}_{X,P}$ for almost all $P\in X$.
\end{prop}
\begin{proof}
  Fix an arbitrary $P\in X$. Since $\underline{k(X)}$ is obtained by
  sheafification of the constant presheaf, there must be an open
  set $U\subseteq X$ and $g\in k(X)$ such that
  $\forall Q\in U,\ [f_{Q}]=[g]$. Next we note that $g$
  is defined for almost all points of $U$ so that $g_{Q}
  \in\mathscr{O}_{X,Q}$ for almost all $Q\in V$.

  Thus, there is an open neighbourhood for every point
  of $X$ where the statement holds. Next we extend this to the whole of $X$.
  Let us construct a sequence of open sets inductively:
  \begin{enumerate}
    \item Choose an arbitrary point $P_{0}\in X$
    \item Let $U_{0}$ be the neighbourhood of $P_{0}$ constructed as above
    \item Assume we have constructed the set $U_{n}$
    \item Choose an arbitrary point $P_{n+1}$ of $X\setminus U_{n}$
    \item Let $U_{n+1}$ be the union of $U_{n}$ with the
          neighbourhood of $P_{n+1}$ constructed as above
  \end{enumerate}
  % Insert picture with X, P_0, U_0, and P_1
  Since $X$ is Noetherian, there must be $N\in\mathbb{N}$
  such that $\forall k\geq N, U_{k+1}=U_{k}$. Moreover, these sets must
  cover $X$, because otherwise the chain wouldn't end at $U_{N}$.
  Therefore, $X$ can be covered by finitely many sets where the statement
  holds.
\end{proof}
\begin{rem}
  This proposition implies that
  \[
    H^{0}(X,\underline{k(X)}/\mathcal{L}(D))\cong \bigoplus_{P\in X}
    k(X)/\mathcal{L}(D)_{P},
  \]
  which might be a helpful way of thinking this cohomology group.
\end{rem}
Now, we define a vector space of families $\{r_{P}\}_{P\in X}$, where we don't
impose any other requirement on $r_{P}$ other than that $r_{P}\in k(X)$ and
$r_{P}\in\mathscr{O}_{X,P}$ for almost all $P\in X$ (Serre calls such a
family a \emph{r\'epartition}).
% TODO: It might be wise to point out that by r_P\in O_{X,P} we
% actually mean (r_P)_P\in O_{X,P}.
Now, I claim that there is a subspace
$S\leq R$ such that $H^{0}(X,\underline{k(X)}/\mathcal{L}(D))\cong R/S$.
This isomorphism will be given by the trivial map
\[
  \varphi: H^{0}(X,\underline{k(X)}/\mathcal{L}(D))\to R/S
  :([f_{P}])_{P\in X}\mapsto [\{f_{P}\}_{P\in X}].
\]
For this map to be well-defined, $([f_{P}])_{P\in X}$ needs to be
mapped to $[0]$ whenever $f_{P}\in\mathcal{L}(D)_{P}$. Since I want
$\varphi$ also to be injective, such elements $(f_{P})_{P\in X}$ should be
the \emph{only} elements that get mapped to $[0]$. Thus, I define $S$
to be the subspace such that $\set{\{r_{P}\}_{P\in X}\mid \ord_{P}(r_{P})
  \geq -D(P)}=:R(D)$, and I claim that this is the right choice of $S$.

\begin{lemm}
  For a divisor $D$ on a curve $X$, we have the following isomorphism:
  \[
    H^{0}(X,\underline{k(X)}/\mathcal{L}(D))\cong R/R(D).
  \]
\end{lemm}
\begin{proof}
  The map $\varphi$ is a well-defined injection by construction,
  so we only need to show it is surjective. Thus,
  suppose $[\{r_{P}\}_{P\in X}]\in R/R(D)$. I want to show that equivalence
  classes $[r_{P}]$ of the components form a global section of the sheaf
  $\underline{k(X)}/\mathcal{L}(D)$. First, let $P_{1},\ldots,P_{r}$
  be the points where $D$ is non-zero and $Q_{1},\ldots,Q_{s}$ be the
  points where $r_{Q_{i}}\not\in \mathscr{O}_{X,Q_{i}}$. Then, let $P\in X$
  be an arbitrary point. We want to find an open neighbourhood $U\ni P$
  and a section $g\in k(X)$ such that $\forall Q\in U,\ [r_{Q}]=[g]$.
  There are two cases:
  \begin{description}[style=nextline]
    \item[$P\not\in\set{P_{1},\ldots,P_{r},Q_{1},\ldots,Q_{s}}\big)$]
          It follows from the definition of the points $P_{i}$ and $Q_{j}$
          that $[r_{P}]=[0]$. And if we let $U$ be the complement of
          the set $\set{P_{1},\ldots,P_{r},Q_{1},\ldots,Q_{s}}$, we see
          that the same hold for every $r_{Q}$ on $U$ so that we can simply
          choose $0\in k(X)$ as the section on the open neighbourhood $U$.
    \item[$P\in\set{P_{1},\ldots,P_{r},Q_{1},\ldots,Q_{s}}\big)$]
          First, denote $Y=\set{P_{1},\ldots,P_{r},Q_{1},\ldots,Q_{s}}
          \setminus \set{P}$ and $g=r_{P}\in k(X)$. Next, let
          $S_{1},\ldots,S_{t}$ be the points where
          $g_{S_{i}}\not\in\mathscr{O}_{X,S_{i}}$. Then, let $U$ be
          the complement of $Y\cup \set{S_{1},\ldots,S_{t}}$. As above,
          $[r_{Q}]=[0]$ for all $Q\in U$ except for $Q=P$. But since
          the points $S_{i}$ are also included in the complement, we have
          that $[g]=[0]$ away from $P$. Thus, $[r_{Q}]=[g]$ on $U$.
  \end{description}
\end{proof}
Now we can return to the SES derived above and replace
$H^{0}(X,\underline{k(X)}/\mathcal{L}(D))$ by $R/R(D)$:
\[
  \begin{tikzcd}
    k(X)\rar & R/R(D)\rar & H^{1}(X,\mathcal{L}(D))\rar & 0.
  \end{tikzcd}
\]
This exact sequence finally gives us the representation of the first
cohomology group: The second map of the sequence is a surjection
onto $H^{1}(X,\mathcal{L}(D))$. The space $k(X)$ can be seen as a subspace
of $R$ and it is thus the kernel of the map. Such a surjection maps $R/R(D)$
onto the space $R\,/\left(R(D)+k(X)\right)$, and thus we get the isomorphism
\[H^{1}(X,\mathcal{L}(D))\cong R/\left(R(D)+k(X)\right).\]
Now, the dual space $\dual{D}$ is simply the space
of linear functionals on $R$, which vanish on $R(D)$ and $k(X)$!

\subsection{Constructing a pairing}
Next I will construct a bilinear form
\[
  \langle -,-\rangle:\diffs{D}\times H^{1}(X,\mathcal{L}(D))\to k.
\]
Note that the space $\diffs{D}$ consists of differential forms $\omega$
such that $(\omega)\geq D$.
%But first we want to understand the space $H^{0}(X,K_{X}
%\otimes\mathcal{L}(D)^{\vee})$ better.
%Consider the stalk of the sheaf
%$K_{X}\otimes\mathcal{L}(D)^{\vee}$ at a point $P$:
%\[
%  \left(K_{X}\otimes\mathcal{L}(D)^{\vee}\right)_{P}
%  =(K_{X})_{P}\otimes_{\mathscr{O}_{X}}\mathcal{L}(D)^{\vee}_{P}
%  =D_{k}(\mathscr{O}_{X})\otimes_{\mathscr{O}_{X}}\mathcal{L}(D)^{\vee}_{P}
%  =D_{k}\left(\mathcal{L}(D)^{\vee}_{P}\right).
%\]
Now, define the bilinear form as follows.
\[
  \langle\omega,r\rangle=\sum_{P\in X}\res_{P}(r_{P}\omega),
\]
where $r=[\{r_{P}\}_{P\in X}]\in R\,/\left(R(D)+k(X)\right)$. The sum is
well-defined, because the term $\res_{P}(r_{P}\omega)$ can be non-zero only
when $P$ is a point such that $D(P)\neq 0$ or $r_{P}\not\in\mathscr{O}_{X,P}$.
Otherwise, $r_{P},f\in\mathscr{O}_{X,P}$, if we write $\omega=f\,dt$
where $t$ is a local uniformiser at $P$. This clearly implies that the
coefficients of the negative terms in the serier expansion of $r_{P}f$
are all zero.
% TODO: Explain why we choose this bilinear form

Now, Serre duality will follow from showing that the map
\[
  i_{D}:\diffs{D}\to \dual{D}
  :\omega\mapsto\langle\omega,-\rangle
\]
is a bijection. But first we need to confirm that $i_{D}$ actually maps
differentials to elements of $\dual{D}$. For a
differential $\omega\in\diffs{D}$, $i_{D}(\omega)$ is of course a linear
functional on $R$, but we need to check that it vanishes on $R(D)$ and
$k(X)$. If $r\in R(D)$, then $(r_{P}\omega)=(r_{P})+(\omega)\geq -D+D=0$
and thus $\res_{P}(r_{P}\omega)=0$ by the same argument as in the last
paragraph. And if $r\in k(X)$, then $\langle r,\omega\rangle=0$ by
Thm.~\ref{thm:residue}. Thus, $i_{D}(\omega)\in \dual{D}$
for every $\omega\in\diffs{D}$.

Now, we can proceed to prove the bijectivity of $i_{D}$, starting with
injectivity.
\begin{prop}\label{prop:injectivity}
  The map $i_{D}:\diffs{D}\to \dual{D}$ is an injection.
\end{prop}
\begin{proof}
  The map is injective if its kernel is trivial. Thus, suppose
  $i_{D}(\omega)=0$. I will show that for every $P\in X$,
  $\ord_{P}(\omega)=\infty$, which implies $\omega=0$.
  Assume to the contrary, so that there is a point $P\in X$ where
  $\ord_{P}(\omega)$ is bounded. But now we can construct a r\'epartition
  $r=[\{r_{Q}\}_{Q\in X}]$ such that $r_{Q}=0$ when $Q\neq P$ and
  $r_{P}=1/t^{\ord_{P}(\omega)+1}$, where $t$ is a local uniformiser at $P$.
  Then,
  \[
    i_{D}(\omega)(r)=\sum_{Q\in X}\res_{Q}(r_{Q}\omega)=\res_{P}(r_{P}\omega)
  \]
  Since $\ord_{P}(r_{P}\omega)=\ord_{P}(r_{P})+\ord_{P}(\omega)
  =-\ord_{P}(\omega)-1+\ord_{P}(\omega)=-1$, we have that $i_{D}(\omega)(r)$ is
  non-zero, which contradicts the assumption that $i_{D}(\omega)=0$.
\end{proof}

\subsection{Proof of surjectivity}
Proving the surjectivity of $\iota_{D}$ is the more challenging and
interesting part. I begin by making the following basic observation.
For any two divisors $D_{1}, D_{2}$ such that $D_{1}\geq D_{2}$, we have
$R(D_{1})\supseteq R(D_{2})$. Therefore, a linear functional vanishing on
$R(D_{1})$ will also vanish on $R(D_{2})$ so that
$H^{1}(X,\mathcal{L}(D_{1}))^{\vee}\subseteq H^{1}(X,\mathcal{L}(D_{2}))^\vee$.
Thus, the spaces $\dual{D}$ form a \emph{filtered
  family}. One can also see that if $D_{1}\geq D_{2}$, then
$\diffs{D_{1}}\subseteq\diffs{D_{2}}$. Moreover, these inclusions trivially
commute with $\iota_{\bullet}$ so that the following square is commutative.
\begin{equation}\label{eq:iota_square}
  \begin{tikzcd}[column sep=large]
    \dual{D_{1}}\rar[hook, shorten=.7em, "i_{D_{1}}^{D_{2}}"] & \dual{D_{2}} \\
    \diffs{D_{1}}\uar{\iota_{D_{1}}}\rar[hook]
    & \diffs{D_{2}}\uar["\iota_{D_{2}}"']
  \end{tikzcd}
\end{equation}
\begin{cat}
  The commutativity of this square shows that the maps $\iota_{\bullet}$
  define a natural transformation between the contravariant functors
  \[
    \diffs{-},\dual{-}:\Div(X)\to k\textbf{-Vect},
  \]
  where $\Div(X)$ is the posetal category of divisors on $X$.
  Thus, not only do we get an isomorphism of the vector spaces
  $\diffs{D}$ and $\dual{D}$, but we also get a natural isomorphism
  between the functors $\diffs{-}$ and $\dual{-}$.
\end{cat}

The strategy to proving the surjectivity of $\iota_{D}$ is to take
advantage of this filtering structure. The following proposition will
let us ``transport the problem along the filtration''.
\begin{prop}\label{prop:invert_inclusion}
  Suppose $D_{1}$ and $D_{2}$ are two divisors on $X$ such that
  $D_{1}\geq D_{2}$. Furthermore, let $\lambda\in\dual{D_{1}}$ and
  $\omega\in\diffs{D_{2}}$. If $i_{D_{1}}^{D_{2}}(\lambda)
  =\iota_{D_{2}}(\omega)$, then $\omega\in\diffs{D_{1}}$ and
  $\iota_{D}(\omega)=\lambda$.
\end{prop}
\begin{proof}
  TODO.
\end{proof}
This proposition is effectively saying that if we can invert $\lambda$
along $\iota_{D^{\prime}}$ for some $D^{\prime}\leq D$, then we can
invert it along $\iota_{D}$. Therefore, if we fix $\lambda\in\dual{D}$,
our goal is to find some divisor $D^{\prime}$ such that it is easy
to invert $\lambda$ along $\iota_{D^{\prime}}$.

Now I will introduce an extra degree of freedom, which I can work with.
Namely, I consider an arbitrary element $\psi\in H^{0}(X,\mathcal{L}(\Delta))$
for some divisor $\Delta$. This section induces a map
\[H^{1}(X,\mathcal{L}(D-\Delta))\to H^{1}(X,\mathcal{L}(D))
:[\{r_{P}\}_{P\in X}]\mapsto [\{\psi r_{P}\}_{P\in X}],\]
It is easy to check that this map is well-defined. Then, the dual map
$\dual{D}\to\dual{D-\Delta}$ is defined so that $(\psi f)(r)
=f(\psi r)$. Note that $\frac1{\psi}\in H^{0}(X,\mathcal{L}((\psi)))$,
and it induces a map $\dual{D-\Delta}\to\dual{D-\Delta-(\psi)}$ in the same
way. If I now take $D^{\prime}=H^{1}(X,\mathcal{L}(D-\Delta-(\psi)))$,
the inclusion $i_{D}^{D^{\prime}}:\dual{D}\to\dual{D^{\prime}}$ can be
factored as follows.
\[\begin{tikzcd}[row sep=large]
    \dual{D}\rar["\psi\cdot"]\drar["i_{D}^{D^{\prime}}"']
    & \dual{D-\Delta}\dar["\frac1{\psi}\cdot"] \\ & \dual{D-\Delta-(\psi)}
  \end{tikzcd}\]
Now, I will prove a result analogous to Prop.~\ref{prop:invert_inclusion},
which lets us move along these maps induced by elements of
$H^{0}(X,\mathcal{L}(D))$.
\begin{prop}\label{prop:invert_multiplication}
  Suppose $D_{1}$ and $D_{2}$ are two divisors on $X$ and $\psi
  \in H^{0}(X,\mathcal{L}(D_{2}))$. Then, the following square commutes.
  \[\begin{tikzcd}[column sep=large]
      \dual{D_{1}}\rar[shorten=.3em,"\psi"] & \dual{D_{1}-D_{2}} \\
      \diffs{D_{1}}\rar["\psi"']\uar["\iota_{D_{1}}"]
      & \diffs{D_{2}}\uar["\iota_{D_{2}}"']
    \end{tikzcd}\]
\end{prop}
\begin{proof}
  Let $\omega\in\diffs{D_{1}}$ and $r\in H^{1}(X,\mathcal{L}(D_{1}-D_{2}))$.
  Then,
  \begin{align*}
    \left(\psi\circ\iota_{D_{1}}\right)(\omega)(r)
    &= \langle \omega, \psi r\rangle \\
    &= \sum_{P\in X}\res(\psi r_{P}\cdot\omega) \\
    &= \langle \omega\psi, r\rangle=\left(\iota_{D_{2}}\circ\psi\right)
      (\omega)(r).
  \end{align*}
  Since this equality holds for every $\omega$ and $r$, we have
  $\psi\circ\iota_{D_{1}}=\iota_{D_{2}}\circ\psi$.
\end{proof}

Now I will invert $\psi\lambda$ along $\iota_{D-\Delta}$, which will finally
let us prove the surjectivity of $\iota_{D}$.
\begin{prop}\label{prop:invert_iota}
  Let $\lambda\in\dual{D}$. Then, there is a divisor $\Delta$,
  a section $\psi\in H^{0}(X,\mathcal{L}(\Delta))$ and a differential
  $\omega\in\diffs{D-\Delta}$ such that $\psi\lambda
  =\iota_{D-\Delta}(\omega)$.
\end{prop}
\begin{proof}
  Let $\Delta$ be an arbitrary divisor. The elements $\psi\lambda$ form a
  subspace
  \[
    \Lambda=\Set{\psi\lambda\mid\psi\in H^{0}(X,\Delta)}
  \]
  of $\dual{D-\Delta}$. I will use a dimensional argument to show that
  $\Lambda$ must interesect with $\im(\iota_{D-\Delta})$. Therefore,
  let us first find a bound for the dimension of $\Lambda$. Consider the map
  \[H^{0}(X,\Delta)\to\dual{D-\Delta}:\psi\mapsto\psi\lambda.\]
  TODO: Finish proof
\end{proof}

Finally, I can bring all propositions together to prove the surjectivity
of $\iota_{D}$.
\begin{prop}\label{prop:surjectivity}
  The map $i_{D}:\diffs{D}\to \dual{D}$ is a surjection.
\end{prop}
\begin{proof}
  Fix an element $\lambda\in\dual{D}$. Then, by Prop.~\ref{prop:invert_iota},
  there is a section $\psi\in H^{0}(X,\mathcal{L}(\Delta))$ and a differential
  $\omega\in\diffs{D-\Delta}$ such that $\psi\lambda=\iota_{D-\Delta}(\omega)$.
  Then,
  \[\lambda=\frac1{\psi}(\psi\lambda)=\frac1{\psi}\iota_{D-\Delta}(\omega),\]
  and by Prop.~\ref{prop:invert_multiplication}, this is
  \[\lambda=\iota_{D-\Delta-(\psi)}(\frac1{\psi}\omega).\]
  Finally, Prop.~\ref{prop:invert_inclusion} implies that
  $\frac1{\psi}\omega\in\dual{D}$ and that $\iota_{D}(\frac1{\psi}\omega)
  =\lambda$, concluding the proof.
\end{proof}
\begin{cat}
  This proof boils down to chasing the following diagram.
  \[\begin{tikzcd}[column sep=-2em]
    & {\dual{D-\Delta}} \\
    {\dual{D}} && {\dual{D-\Delta-(\psi)}} \\
    & {\diffs{D-\Delta}} \\
    {\diffs{D}} && {\diffs{D-\Delta-(\psi)}}
    \arrow["\psi\cdot", from=2-1, to=1-2]
    \arrow["{\frac1{\psi}\cdot}", from=1-2, to=2-3]
    \arrow["\iota_D", from=4-1, to=2-1]
    \arrow["{\iota_{D-\Delta}}"{description, pos=0.7}, from=3-2, to=1-2]
    \arrow["\iota_{D-\Delta-(\psi)}"', from=4-3, to=2-3]
    \arrow[hook, crossing over, from=2-1, to=2-3]
    \arrow[hook, from=4-1, to=4-3]
    \arrow["\psi\cdot", from=4-1, to=3-2]
    \arrow["{\frac1{\psi}\cdot}", from=3-2, to=4-3]
  \end{tikzcd}\]
\end{cat}

\subsection{Conclusion}
We finally arrive at the Serre Duality theorem!
\begin{thm}[Serre Duality]
  If $X$ is an algebraic curve as in the previous section
  and $D$ is a divisor on $X$, there is an isomorphism
  \[
    H^{1}(X, \mathcal{L}(D))^{\vee}\cong H^{0}(X, K_{X}
    \otimes \mathcal{L}(D)^{\vee}).
  \]
  of $k$-vector spaces, where $K_{X}$ is the canonical divisor of $X$.
\end{thm}
\begin{proof}
  Combining Propositions \ref{prop:injectivity} and \ref{prop:surjectivity}
  shows that the linear map
  \[i_{D}:\diffs{D}\to \dual{D}\]
  is a bijection so that it defines an isomorphism between the two spaces.
\end{proof}
